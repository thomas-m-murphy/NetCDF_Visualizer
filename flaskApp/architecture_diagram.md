# NetCDF Visualizer – Architecture Overview

This file provides a detailed overview of the system architecture, including which classes, functions, and files are involved in different use cases.

---

## System Architecture Diagram

```text
User Browser
    |
    |  (HTTP Requests)
    v
Flask Server (app.py)
    |
    |-- / (index)
    |      |-- Renders 'index.html'
    |
    |-- /upload (POST)
    |      |-- app.upload()
    |           |-- Calls read_nc_variables() from htmlPlotFieldLines.py
    |           |-- Calls downsample_data_dict() from htmlPlotFieldLines.py
    |           |-- Calls plot_multiple_2d_cross_sections_3d() from htmlPlotCrossSection.py
    |           |-- Calls create_3d_contour_plot() from htmlPlotFieldLines.py
    |
    |-- /field-line (POST)
    |      |-- app.field_line()
    |           |-- Updates global field line list
    |           |-- Calls _rebuild_3d_html()
    |                |-- Calls create_3d_contour_plot() from htmlPlotFieldLines.py
    |
    |-- /delete-field-line (POST)
    |      |-- app.delete_field_line()
    |           |-- Updates global field line list
    |           |-- Calls _rebuild_3d_html()
    |                |-- Calls create_3d_contour_plot() from htmlPlotFieldLines.py
    |
    |-- /generate-line-plot (POST)
           |-- app.generate_line_plot()
                |-- Calls extract_data() from plotLineGraph.py
                |-- Calls create_multi_plot() from plotLineGraph.py

Static Files (static/)
    ├── 3d_contour_plot.html (generated by create_3d_contour_plot)
    ├── multiple_cross_section_3d.html (generated by plot_multiple_2d_cross_sections_3d)
    ├── multi_variable_line_graph.png (generated by create_multi_plot)

Templates (templates/)
    ├── index.html (Upload form, plotting UI)
    ├── linePlot.html (Line graph viewing page)

Uploads Folder (uploads/)
    ├── Uploaded .nc files (temporary)

fldData Folder (fldData/)
    ├── Cached field line data (optional future use)

```

---

## Detailed Request Flow Examples

### ➡ Uploading a NetCDF File
1. **User uploads a file** via `/` route (index.html form).
2. Flask `/upload` route triggers:
   - `read_nc_variables()` reads variables.
   - `downsample_data_dict()` downsamples large arrays.
   - `plot_multiple_2d_cross_sections_3d()` creates 2D cross-section slices.
   - `create_3d_contour_plot()` generates initial 3D plot (without field lines).
3. Static HTML output written to `static/3d_contour_plot.html`.

### ➡ Adding a Field Line (Manual or Click)
1. **User clicks** on plot (or manually enters coordinates).
2. JavaScript injects click via `postMessage` to `/field-line` endpoint.
3. Flask `/field-line` route triggers:
   - Adds seed coordinates to `global_data['field_lines']`.
   - Calls `_rebuild_3d_html()` which:
     - Rebuilds the 3D plot via `create_3d_contour_plot()`.
     - Calls `compute_streamlines_pyvista()` internally to trace each streamline.
     - PyVista's `streamlines()` method called under the hood.
4. Updated HTML replaces the plot.

### ➡ Deleting a Field Line
1. **User deletes a field line** from the interface.
2. Flask `/delete-field-line` route triggers:
   - Removes selected seed from `global_data['field_lines']`.
   - Calls `_rebuild_3d_html()` which regenerates the plot.

### ➡ Generating a Time-Series Line Plot
1. **User selects variables and coordinates** for a time-series plot.
2. Flask `/generate-line-plot` route triggers:
   - `extract_data()` extracts time-series slices.
   - `create_multi_plot()` renders a multi-variable line plot.
   - Static PNG saved under `static/`.


---

## Notes and Highlights

- Field lines are retraced and redrawn **every time** a seed is added or deleted.
- PyVista is used for 3D streamline computation.
- Plotly is used for interactive 3D contour surfaces and line graphs.
- Uploads are stored **temporarily** — large `.nc` files can be manually cleared from `uploads/`.

---

_Last updated: 2025-04-29_

